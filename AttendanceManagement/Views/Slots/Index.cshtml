@using AttendanceManagement.Models.ViewModel
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model IEnumerable<AttendanceManagement.Models.TimeTable.Slot>

@{
    ViewData["Title"] = "Slots";
    Layout = "~/Views/Shared/_Layout.cshtml";
    PageCardHeading pageCardHeading = new PageCardHeading
    {
        Heading = "Slots",
        Icon = "Icons/_SlotIcon"
    };
}

            <partial name="Common/_PageCardHeading" model="pageCardHeading"/>


<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
    <div class="container-xxl" id="kt_content_container">

        <div class="card">
            <div class="card-header border-0 pt-6">
                <div class="card-title">
                    <div class="d-flex align-items-center position-relative my-1">
                        @Html.Partial("Common/_SearchTextBox", "Slot")
                        <partial name="Common/_TableReload"/>
                    </div>
                </div>
                <div class="card-toolbar">
                    <div class="d-flex justify-content-end" data-kt-customer-table-toolbar="base">
                        <partial name="Common/_ExportButton"/>
                        <button type="button" class="btn btn-primary" onclick="AddSlot()" data-bs-toggle="modal" data-bs-target="#modal_add_1">
                            Add Slot
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0" id="TableContainer">
                <table id="SlotDataTable" class="table align-middle table-row-dashed fs-6 gy-5">
                    <thead>
                    <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                        <th>Day</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Teacher</th>
                        <th>Course</th>
                        <th>Room</th>
                        <th>Link</th>
                        <th>Batch</th>
                        <th class="text-end min-w-100px">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="text-gray-600 fw-bold">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script defer>
var KTDatatablesServerSide = function () {
    // Shared variables
    var table;
    var dt;

    // Private functions
    var initDatatable = function () {
        dt = $("#SlotDataTable").DataTable({
            searchDelay: 200,
            processing: true,
            serverSide: true,
            "ordering": false,
            lengthMenu: [10, 25, 50, 100, 500, 1000,5000],
            stateSave: true,
            select: {
                style: 'os',
                selector: 'td:first-child',
                className: 'row-selected'
            },
            ajax: {
                url: "/Home/SlotPageData",
                type: "POST",
            },
            columns: [
                { data: 'day'},
                { data: 'startTime'},
                { data: 'endTime'},
                { data: 'teacher.user.email'},
                { data: 'course.name'},
                { data: 'room.name'},
                { data: 'link'},
                { data: 'id'},
                { data: 'id' },
            ],
            columnDefs: [
                {
                     "defaultContent": "",
                     "targets": "_all",
                },
                {
                    targets: [3,4,5,6],
                    render: function (data) {
                        try {
                            return data;
                        } catch (e) {
                            return " ";
                        }                          
                    }
                },
                {
                    targets: [1,2],
                    render: function (data) {
                        try{
                            return moment(data).format('hh:mm a');
                        }
                        catch (e) {
                            return data;
                        }
                    }
                },
                 {
                     targets: 0,
                     render: function (data){
                         if (data == "1")
                             return "Monday";
                         else if (data == "2")
                             return "Tuesday";
                         else if (data == "3")
                             return "Wednesday";
                         else if (data == "4")
                             return "Thursday";
                         else if (data == "5")
                             return "Friday";
                         else if (data == "6")
                             return "Saturday";
                         else if (data == "7")
                             return "Sunday";
                         else
                             return "";
                     }
                 },     
                 {
                     targets: 7,
                     render: function (data, type, row) {
                         try{
                             return GenerateAdditionalEdit(data);
                         }
                         catch (e) {
                             return data;
                         }

                     }
                 },       
                {
                    targets: -1,
                    data: null,
                    orderable: false,
                    className: 'text-end',
                    render: function (data, type, row) {
                        try{
                            return GenerateActionButton(data);
                        }
                        catch (e) {
                            return "-";
                        }
                    },
                },
            ],
        });

        table = dt.$;

        dt.on('draw', function () {
            handleDeleteRows();
            KTMenu.createInstances();
        });
    }

    var handleDeleteRows = () => {
        // Select all delete buttons
        const deleteButtons = document.querySelectorAll('[data-kt-docs-table-filter="delete_row"]');

        deleteButtons.forEach(d => {
            // Delete button on click
            d.addEventListener('click', function (e) {
                e.preventDefault();

                // Select parent row
                const parent = e.target.closest('tr');
                console.log(parent.querySelectorAll('td')[8])

                // Get customer name
                const customerName = parent.querySelectorAll('td')[0].innerText;
                const customerName1 = parent.querySelectorAll('td')[3].innerText;
                const courseName = parent.querySelectorAll('td')[4].innerText;

                // SweetAlert2 pop up --- official docs reference: https://sweetalert2.github.io/
                Swal.fire({
                    text: "Are you sure you want to remove " + customerName + " Lecture(" + courseName + ") Of " + customerName1,
                    icon: "error",
                    showCancelButton: true,
                    buttonsStyling: false,
                    confirmButtonText: "Yes, delete!",
                    cancelButtonText: "No, cancel",
                    customClass: {
                        confirmButton: "btn fw-bold btn-danger",
                        cancelButton: "btn fw-bold btn-active-light-primary"
                    }
                }).then(function (result) {
                    if (result.value) {
                        const dataSelect = parent.querySelectorAll('td')[8].querySelectorAll('a')[0].id
                        $.ajax({
                            url: `/Slots/Delete`,
                            data: {
                                id: dataSelect
                            },
                            type : "Delete",
                            success: function (result) {
                                if (result) {
                                     dt.row(parent).remove().draw();                                    
                                }
                            },
                            error: function (result) {
                                Swal.fire({
                                    text: customerName + " was not deleted.",
                                    icon: "error",
                                    buttonsStyling: false,
                                    confirmButtonText: "Ok, got it!",
                                    customClass: {
                                        confirmButton: "btn fw-bold btn-primary",
                                    }
                                });
                            }
                        })
                        
                    } else if (result.dismiss === 'cancel') {
                        Swal.fire({
                            text: customerName + " was not deleted.",
                            icon: "error",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn fw-bold btn-primary",
                            }
                        });
                    }
                });
            })
        });
    }

   // Public methods
    return {
        init: function () {
            initDatatable();
            handleSearchDatatable(dt);
            handleDeleteRows();
            handleResetForm(dt);
            exportButtons(dt);
        }
    }
}();

function ShowEdit(email){
    $.ajax({
        url : `/Slots/Edit?id=${email}`,
        type : 'GET',
        success : function(data){
            $('#modal_edit_1').modal('show');
            $('#inner-body-display-edit-1').html(data);
        }
    })
}

function ShowEdit1(data){
    $.ajax({
        url : `/SlotBatches/Index?id=${data}`,
        type : 'GET',
        success : function(data){
            $('#modal_edit_1').modal('show');
            $('#inner-body-display-edit-1').html(data);
        }
    })
}

setTimeout(() => {
    KTDatatablesServerSide.init();
}, 100);


</script>
<script>

    function AddSlot(){
        $.ajax({
            url: "/Slots/Create",
            type: "GET",
            success: function (result) {
                $("#inner-body-display").html(result)
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        })
    }


</script>