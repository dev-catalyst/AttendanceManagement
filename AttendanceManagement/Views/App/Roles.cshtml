@model IEnumerable<AttendanceManagement.Models.TimeTable.Course>

@{
    ViewData["Title"] = "Roles";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
    <div class="container-xxl" id="kt_content_container">
        <div class="card card-flush pb-0 bgi-position-y-center bgi-no-repeat mb-10 ">
            <div class="card-header pt-10">
                <div class="d-flex align-items-center">
                    <div class="symbol symbol-circle me-5">
                        <div class="symbol-label bg-transparent text-primary border border-secondary border-dashed">
                            <span class="svg-icon svg-icon-2x svg-icon-primary">
                                <partial name="Icons/_RoleIcon"/>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h2 class="mb-1">Roles</h2>
                    </div>
                </div>
            </div>
            <div class="card-body pb-0">
                <div class="d-flex overflow-auto h-55px">
                    <ul class="nav nav-stretch nav-line-tabs nav-line-tabs-2x border-transparent fs-5 fw-bold flex-nowrap">
                        <li class="nav-item user-select-none">
                            <a class="nav-link text-active-primary me-6 active">All Roles</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>


        <div class="card">
            <div class="card-header border-0 pt-6">
                <div class="card-title">
                    <div class="d-flex align-items-center position-relative my-1">
                        @Html.Partial("Common/_SearchTextBox", "Role")
                        <partial name="Common/_TableReload"/>
                    </div>
                </div>
                <div class="card-toolbar">
                    <div class="d-flex justify-content-end" data-kt-customer-table-toolbar="base">
                        <button type="button" class="btn btn-primary" onclick="AddUser()" data-bs-toggle="modal" data-bs-target="#modal_add_1">
                            Add Role
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body pt-0" id="TableContainer">
                <table id="CustomDataTable" class="table align-middle table-row-dashed fs-6 gy-5">
                    <thead>
                    <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0">
                        <th>Role Name</th>
                        <th class="text-end min-w-100px">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="text-gray-600 fw-bold">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script defer>
var KTDatatablesServerSide = function () {
    // Shared variables
    var table;
    var dt;

    // Private functions
    var initDatatable = function () {
        dt = $("#CustomDataTable").DataTable({
            searchDelay: 200,
            processing: true,
            serverSide: true,
            order: [[0, 'desc']],
            stateSave: true,
            select: {
                style: 'os',
                selector: 'td:first-child',
                className: 'row-selected'
            },
            ajax: {
                url: "/App/PageDataRole",
            },
            columns: [
                { data: 'name'},
                { data: 'id' }
            ],
            columnDefs: [       
                {
                    targets: -1,
                    data: null,
                    orderable: false,
                    className: 'text-end',
                    render: function (data, type, row) {
                        try{
                            return GenerateActionButton(data);
                        }
                        catch (e) {
                            return "-";
                        }
                    },
                },
            ],
        });

        table = dt.$;

        // Re-init functions on every table re-draw -- more info: https://datatables.net/reference/event/draw
        dt.on('draw', function () {
            handleDeleteRows();
            KTMenu.createInstances();
        });
    }

    var handleDeleteRows = () => {
        // Select all delete buttons
        const deleteButtons = document.querySelectorAll('[data-kt-docs-table-filter="delete_row"]');

        deleteButtons.forEach(d => {
            // Delete button on click
            d.addEventListener('click', function (e) {
                e.preventDefault();

                // Select parent row
                const parent = e.target.closest('tr');

                // Get customer name
                const customerName = parent.querySelectorAll('td')[0].innerText;

                // SweetAlert2 pop up --- official docs reference: https://sweetalert2.github.io/
                Swal.fire({
                    text: "Are you sure you want to remove " + customerName + " User?",
                    icon: "error",
                    showCancelButton: true,
                    buttonsStyling: false,
                    confirmButtonText: "Yes, delete!",
                    cancelButtonText: "No, cancel",
                    customClass: {
                        confirmButton: "btn fw-bold btn-danger",
                        cancelButton: "btn fw-bold btn-active-light-primary"
                    }
                }).then(function (result) {
                    if (result.value) {
                        const dataSelect = parent.querySelectorAll('td')[4].querySelectorAll('a')[0].id
                        $.ajax({
                            url: `/App/DeleteUser`,
                            data: {
                                id: dataSelect
                            },
                            type : "Delete",
                            success: function (result) {
                                if (result) {
                                     dt.row(parent).remove().draw();                                    
                                }
                            },
                            error: function (result) {
                                
                                Swal.fire({
                                    text: customerName + " was not deleted.",
                                    icon: "error",
                                    buttonsStyling: false,
                                    confirmButtonText: "Ok, got it!",
                                    customClass: {
                                        confirmButton: "btn fw-bold btn-primary",
                                    }
                                });
                            }
                        })
                        
                    } else if (result.dismiss === 'cancel') {
                        Swal.fire({
                            text: customerName + " was not deleted.",
                            icon: "error",
                            buttonsStyling: false,
                            confirmButtonText: "Ok, got it!",
                            customClass: {
                                confirmButton: "btn fw-bold btn-primary",
                            }
                        });
                    }
                });
            })
        });
    }
  

    // Public methods
    return {
        init: function () {
            initDatatable();
            handleSearchDatatable(dt);
            handleDeleteRows();
            handleResetForm(dt);
        }
    }
}();

function ShowEdit(email){
    $.ajax({
        url : `/App/EditUser?id=${email}`,
        type : 'GET',
        success : function(data){
            $('#modal_edit_1').modal('show');
            $('#inner-body-display-edit-1').html(data);
        }
    })
}

setTimeout(() => {
    KTDatatablesServerSide.init();
}, 100);


</script>
<script>

    function AddUser(){
        $.ajax({
            url: "/App/AddUser",
            type: "GET",
            success: function (result) {
                $("#inner-body-display").html(result)
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        })
    }


</script>